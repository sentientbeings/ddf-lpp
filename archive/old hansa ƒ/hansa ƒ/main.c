/* this is the main routine and its associated event loop for the program Hansa.	*/#include "main.h"#include "mainP.h"// main event loopvoid main(void){	initializeApplication();	while (true)		processAnEvent();}/* local procedures */// the user has chosen a menu item -- go do itBoolean doMenuCommand(long mResult){	register int		theItem;	Str255		name;	theItem = LoWord( mResult );	switch (HiWord(mResult)) {	case appleID:		GetItem(GetMenu(appleID), theItem, name); // trc why does name seem wrong here?		OpenDeskAcc(name ); // trc ditto		break;	case fileID: 		DoFile(theItem);		break;	case helpID:		Alert(alertID[theItem], 0L);		break;	}				HiliteMenu(0);	return(true);}/* differentiate between a single click, double click, and drag. A double click occurs if *//* there is a second mouseDown event in the event queue before the system double time is up; *//* a drag happens if the mouse is still down after half that time is up (on some machines you *//* can get here befor a user has lefted his finger from the mouse); and a single click happens*//* otherwise. */enum mouseEventType getTypeOfMouseEvent(Point where){	register long startTime;	EventRecord nextEvent;		startTime = TickCount();	while (TickCount() <= startTime + GetDblTime())		if ((EventAvail(mDownMask, &nextEvent) == true) && 			(PointsNear(where, nextEvent.where) == true)) {			GetNextEvent(mDownMask, &nextEvent);			return doubleClick;		} else if ((TickCount() >= (GetDblTime()>>1) + startTime) && (WaitMouseUp() == true))			return dragClick;		return singleClick;}void initializeApplication(void) {	InitGraf(&(qd.thePort));	InitFonts();	InitWindows();	InitMenus();	TEInit(); /* this program doesn't use TextEdit, but still must be prepared for desk accessories to */	InitDialogs(0L);	InitCursor();	GetDateTime((unsigned long *) &(qd.randSeed));	setUpMenus();	InitMapType();	InitPlayerInfo();	InitDisplay();	InitLeagueIcons();	InitAnimation();	DoStartUp(); /* check to see if we came from the finder by double clicking on something */}// if this is a window generated by the game?Boolean ours(CWindowPtr w){	return( (w==GetMapWindow()) || 			(w == (CWindowPtr)GetTradeWindow()) ||			(w == (CWindowPtr)GetOfferWindow()) ||			(MatchProductionWindow((WindowPtr)w) != noCity));}// the event loopBoolean processAnEvent(void){	short 			city;	EventRecord		myEvent;	CWindowPtr		whichWindow = NULL;	SystemTask();	if (GetNextEvent(everyEvent, &myEvent)) {		if (IsDialogEvent(&myEvent) == true)			ProcessDialogEvent(&myEvent, (WindowPtr) whichWindow);		else {			switch (myEvent.what) {			case mouseDown:				switch (FindWindow( myEvent.where, (WindowPtr *) &whichWindow )) {								case inGoAway:					if (ours(whichWindow))						if ((city = MatchProductionWindow((WindowPtr)whichWindow)) != noCity)							CloseProductionWindow(city);						else CloseTradeWindow(true);						break;				case inMenuBar:					doMenuCommand(MenuSelect(myEvent.where));					break;									case inSysWindow:					SystemClick( &myEvent, (WindowPtr) whichWindow );					break;									case inDrag:					if (ours(whichWindow)) 						DragWindow((WindowPtr) whichWindow, myEvent.where, &dragRect );					break;									case inContent:					if ((WindowPtr)whichWindow != FrontWindow()) 						SelectWindow((WindowPtr) whichWindow);					if (ours(whichWindow))						DoContent((WindowPtr)whichWindow, &myEvent, getTypeOfMouseEvent(myEvent.where));					break;				} /* end switch FindWindow */				break;			case keyDown:			case autoKey: 				{				register char	theChar;							theChar = myEvent.message & charCodeMask;				if ((myEvent.modifiers & cmdKey) != 0) 					doMenuCommand( MenuKey( theChar ) );				}				break;			case updateEvt: 				if (ours((CWindowPtr)myEvent.message)) 					UpdateWindow((WindowPtr)myEvent.message);				break;								} /* end of case myEvent.what */		}	return true;	} else {		UpdateAnimation();		return false;	}}/* initialize the menu bar */void setUpMenus(void){	const HANSA_MENU_BAR = 128;		SetMenuBar(GetNewMBar(HANSA_MENU_BAR));	AddResMenu( GetMenu(appleID), 'DRVR' );	DrawMenuBar();}