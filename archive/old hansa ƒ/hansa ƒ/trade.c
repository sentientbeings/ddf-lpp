/* this file contains the trade information for the game Hanseatic 		*//* League.																*/#include "trade.h"#include "tradeP.h"/* PUBLIC PROCEDURES */void CloseTradeWindow(Boolean player){	if ((tradePtr != NULL) && (player || (GetLeague(GetTradeCity1()) != GetCurrentPlayer()))) {		DisposDialog(tradePtr);		tradePtr = NULL;		setTradeCities(noCity, noCity);	}}short GetTradeCity1(void){	return tradeCity1;}short GetTradeCity2(void){	return tradeCity2;}DialogPtr GetTradeWindow(void){	return tradePtr;}/* what we have to do when an event occurs in a dialog box */void ProcessTradeEvent(EventRecord *eventP, DialogPtr dialogP, int item){	Rect 			drawRect;	ControlHandle 	goodH;	short 			type, attempt, controlValue;		GetDItem(dialogP, item, &type, (Handle *) &goodH, &drawRect);	if (item == cancelTradeButtonItem) {		CancelTrade(GetTradeCity1(), GetTradeCity2());		UpdateProductionWindows(GetTradeCity1(), GetTradeCity2());		ShowTradeWindow(GetTradeCity1(), GetTradeCity2(), false);	}	if (item == production1Item)		ShowProductionWindow(GetTradeCity1(), true);	else if (item == production2Item)		ShowProductionWindow(GetTradeCity2(), true);	else if (type == (ctrlItem+resCtrl)) {		GlobalToLocal(&(eventP->where)); 		switch (TestControl(goodH, eventP->where)) {			case inDownButton:			if (GetCtlValue(goodH) < GetCtlMax(goodH))				changeTradeValue(item, -1);			break;		case inUpButton:			if (GetCtlValue(goodH) > GetCtlMin(goodH))				changeTradeValue(item, 1);			break;		case inPageUp:			if (GetCtlValue(goodH) != (controlValue = (int) (GetCtlMax(goodH)/2										-GetTradeBetweenCities(GetTradeCity1(), GetTradeCity2(), getTradeGood[item])))) {				if ((attempt = controlValue - GetCtlValue(goodH)) <= GetItemTotal(GetTradeCity1(), getTradeGood[item]))					changeTradeValue(item, attempt);				else changeTradeValue(item, -GetItemTotal(GetTradeCity1(), getTradeGood[item]));			} else if (GetItemTotal(GetTradeCity2(), getTradeGood[item]) >= 5)					changeTradeValue(item, 5);			else changeTradeValue(item, GetItemTotal(GetTradeCity2(), getTradeGood[item]));			break;					case inPageDown:			if (GetCtlValue(goodH) != (controlValue = (int) (GetCtlMax(goodH)/2										-GetTradeBetweenCities(GetTradeCity1(), GetTradeCity2(), getTradeGood[item])))) {				if ((attempt = controlValue - GetCtlValue(goodH)) <= GetItemTotal(GetTradeCity2(), getTradeGood[item]))					changeTradeValue(item, attempt);				else changeTradeValue(item, GetItemTotal(GetTradeCity2(), getTradeGood[item]));			} else if (GetItemTotal(GetTradeCity1(), getTradeGood[item]) >= 5)					changeTradeValue(item, -5);			else changeTradeValue(item, -GetItemTotal(GetTradeCity1(), getTradeGood[item]));			break;		case inThumb:			if (GetCtlValue(goodH) < (controlValue = (int) (GetCtlMax(goodH)/2										-GetTradeBetweenCities(GetTradeCity1(), GetTradeCity2(), getTradeGood[item])))) {				if ((attempt = GetCtlValue(goodH) - controlValue) <= GetItemTotal(GetTradeCity2(), getTradeGood[item]))					changeTradeValue(item, -attempt);				else changeTradeValue(item, -GetItemTotal(GetTradeCity2(), getTradeGood[item]));			} else 	if (GetCtlValue(goodH) > (controlValue = (int) (GetCtlMax(goodH)/2						-GetTradeBetweenCities(GetTradeCity1(), GetTradeCity2(), getTradeGood[item])))) {				if ((attempt = controlValue - GetCtlValue(goodH)) <= GetItemTotal(GetTradeCity1(), getTradeGood[item]))					changeTradeValue(item, attempt);				else changeTradeValue(item, GetItemTotal(GetTradeCity1(), getTradeGood[item]));			}		}		ShowTradeWindow(GetTradeCity1(), GetTradeCity2(), false);		UpdateProductionWindows(GetTradeCity1(), GetTradeCity2());	}}void ShowTradeWindow(short city1, short city2, Boolean select){	ControlHandle 	goodH;	enum goodTypes 	good;	short			type, i;	Rect 			invalRect;	Str255			numberString, title, transportCost1, transportCost2;	Str255			testString;		if (tradePtr == NULL) {		SetPort(tradePtr = GetNewDialog(tradeID, 0L, (WindowPtr)-1L));		for (i = tUtilityBar1Item; i <= tLaborBar2Item; i++) {			GetDItem(tradePtr, i, &type, (Handle *) &goodH, &invalRect); 			SetDItem(tradePtr, i, userItem, (Handle) &drawTradeItems, &invalRect);		}		ShowWindow(tradePtr);	} else SetPort(tradePtr);	if ((city1 != GetTradeCity1()) || (city2 != GetTradeCity2())) {		title[0] = 0;		concatP((char *)title, (char *)GetCityName(city1));		concatP((char *)title, (char *)"\p trades with ");		concatP((char *)title, (char *)GetCityName(city2));		SetWTitle(tradePtr, title);		setTradeCities(city1, city2);	}	for (good = wheat; good < numberOfGoods; good++) {		GetProductionTradeString((char *)numberString, city1, good);		GetDItem(tradePtr, tradeAmount1Item[good], &type, (Handle *) &goodH, &invalRect);		GetIText((Handle) goodH, testString);		if (!EqualString(numberString, testString, true, true))			SetIText((Handle) goodH, numberString);		GetProductionTradeString((char *)numberString, city2, good);		GetDItem(tradePtr, tradeAmount2Item[good], &type, (Handle *) &goodH, &invalRect);		GetIText((Handle) goodH, testString);		if (!EqualString(numberString, testString, true, true))			SetIText((Handle) goodH, numberString);				GetDItem(tradePtr, tradeScrollBar[good], &type, (Handle *) &goodH, &invalRect);		if ((GetItemTotal(city1, good) > 0) ||			(GetItemTotal(city2, good) > 0)) {			HiliteControl(goodH, 0);			SetCtlValue(goodH, (int) (GetCtlMax(goodH)/2)-GetTradeBetweenCities(city1, city2, good));		} else			HiliteControl(goodH, 255);	}		if (select)		SelectWindow(tradePtr);	GetDItem(tradePtr, transportCost1Item, &type, (Handle *) &goodH, &invalRect);	GetTransportCostString((char *)transportCost1, GetTransportCosts(city1, city2, noGood), true, city1) ;	GetIText((Handle) goodH, testString);	if (!EqualString(transportCost1, testString, true, true))		SetIText((Handle) goodH, transportCost1);	GetDItem(tradePtr, transportCost2Item, &type, (Handle *) &goodH, &invalRect);	GetTransportCostString((char *)transportCost2, GetTransportCosts(city2, city1, noGood), true, city2);	GetIText((Handle) goodH, testString);	if (!EqualString(transportCost2, testString, true, true))		SetIText((Handle) goodH, transportCost2);	DrawUtilityBar(tradePtr, tUtilityBar1Item, tUtilityAmount1Item);	DrawUtilityBar(tradePtr, tUtilityBar2Item, tUtilityAmount2Item);	DrawLaborBar(tradePtr, tLaborBar1Item, tLaborAvailable1Item, false);	DrawLaborBar(tradePtr, tLaborBar2Item, tLaborAvailable2Item, false);}void TryToJoinTradeLeague(short city1, short city2){	register short	cost;	Str255			numberString;			if (GetUtility(city1) <= GetAutarchicLevel(city1)) {		ParamText(GetCityName(city1), GetCityName(city2), numberString, 0L);		Alert(belowAutarchyID, 0L);	} else if ((cost = (GetTransportCosts(city1, city2, noGood)+100)/100*100) > LaborAvailable(city1)) {		NumToString(cost/100, numberString);		ParamText(GetCityName(city1), GetCityName(city2), numberString, 0L);		Alert(notEnoughLaborID, 0L);	} else {		NumToString(cost/100, numberString);		ParamText(GetCityName(city2), GetCityName(city2), numberString, 0L);		if (Alert(offerToJoinTradeLeagueID, 0L) == yesItem) {			UpdateWindow((WindowPtr)GetMapWindow());			SetOfferLevel(city2, city1, 0.0);			OpenOfferWindow(city2);			AddToMissionCost(city1, cost);			UpdateProductionWindows(city1, city2);			UpdateTradeWindow();		}	}}/* redo the trade window if one of the production windows has changed */void UpdateTradeWindow(void){	short city;		if ((tradePtr != NULL) && 		(((city = GetProductionCity()) == GetTradeCity1()) || (city == GetTradeCity2())))		ShowTradeWindow(GetTradeCity1(), GetTradeCity2(), false);}/* PRIVATE PROCEDURES */Boolean changeTradeValue(int item, int amount){	enum goodTypes good;	short city1, city2;		if (((GetItemTotal(city1 = GetTradeCity2(), good = getTradeGood[item]) - amount) >= 0) &&		((GetItemTotal(city2 = GetTradeCity1(), good) + amount) >= 0) &&		EnoughLaborToTransport(city1, city2, good, amount)) {			ChangeImportExport(city1, city2, good, amount);			return true;	} else return false;}pascal void drawTradeItems(DialogPtr dPtr, int itemNumber){	switch (itemNumber) {		case tLaborBar1Item:		DrawLaborBar(dPtr, tLaborBar1Item, tLaborAvailable1Item, true);		break;	case tLaborBar2Item:		DrawLaborBar(dPtr, tLaborBar2Item, tLaborAvailable2Item, true);		break;		case tUtilityBar1Item:		DrawUtilityBar(dPtr, tUtilityBar1Item, tUtilityAmount1Item);		break;				case tUtilityBar2Item:		DrawUtilityBar(dPtr, tUtilityBar2Item, tUtilityAmount2Item);		break;				}}long getMissionCost(double dist){	if (dist <= 4.0)		return (long) 100;	else return (long) ((dist*100.0)-300.0);}