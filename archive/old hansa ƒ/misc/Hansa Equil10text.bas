00001 '   Finding Market Equilibrium00000 '00000 '   Problem: Large city number? Getting stuck in second part.00003 '00004 DEFDBL INT A-Z00005 00006 DIM Cost&(7),CityToBuyFrom(50),ProdnCost(7,50),Quantity!(7),Price(7),Cost&(7),BestSeller(7)00007 DIM LaborPrice(50),Labor(50),LaborWorth(50),LaborDemand(50),TransportCost(50,50)00000 DIM CityExcessDemand(50),OldLaborPrice(50),OneCityFactor!(50),Tried(50)00009 '00010 True=(1=1):False=NOT True00011 'Set Parameters00012 PriceAdjustment!=.02:MaxExcessDemand=10000:CostMax=1000000013 NCity=10:NGood=500014 DEF TAB 700015 '00016 LONG FN MaxUtility(Wealth,Price1,Price2,Price3,Price4,Price5)00017 	'Calculates Quantities consumed to maximize utility00018 	'as Quantity(1),Quantity(2), ...00019 GdsConsumed=-((Price1<>CostMax)+(Price2<>CostMax)+(Price3<>CostMax)+(Price4<>CostMax)+(Price5<>CostMax))00020 W=Wealth/GdsConsumed:                         'PRINT "W";W;"Gds";GdsConsumed,00021 IF Price1<>CostMax THEN Quantity!(1)=W\Price1 ELSE Quantity!(1)=000022 IF Price2<>CostMax THEN Quantity!(2)=W\Price2 ELSE Quantity!(2)=000023 IF Price3<>CostMax THEN Quantity!(3)=W\Price3 ELSE Quantity!(3)=000024 IF Price4<>CostMax THEN Quantity!(4)=W\Price4 ELSE Quantity!(4)=000025 IF Price5<>CostMax THEN Quantity!(5)=W\Price5 ELSE Quantity!(5)=000026 END FN00027 '00028 WINDOW 1,"Equilibrate",(10,40)-(1100,700)00029 00030 GOSUB "Setup"00031 T&=TIMER:Count=000032 'FOR Iteration=1 TO 6000033 DO00034    GOSUB "Calculate Demands":GOSUB "Calculate Excess Demands":00035   	PRINT "Exc Demand=";TotalExcessDemand!,"CityXD=";CityExcessDemand(CityToChange),"DeltaLP=";DeltaLaborPrice!,"C2Ch=";CityToChange,OneCityFactor!(CityToChange),"LPrice=";LaborPrice(CityToChange)00036    IF PriceAdjustment!>.001 THEN GOSUB "Change Many Cities" ELSE GOSUB "Change One City2":00037    Count=Count+100038 UNTIL (TotalExcessDemand!<MaxExcessDemand) OR (INKEY$="Q") OR ((TIMER-T&)>50) OR (Count>200)00039 'NEXT Iteration00040 '00041   	FOR City=1 TO NCity:00042       PRINT "City:";City,"1CtyFctr=";OneCityFactor!(City),"CtyXDmd=";CityExcessDemand(City),"LaborWth=";LaborWorth(City)00043    NEXT City00044 BREAK ON00045 WHILE INKEY$<>"q"00046 WEND00047 END00048 BREAK OFF00049 '00050 "Setup":  'This fakes the initial conditions00051 FOR City1=1 TO NCity STEP 1:00052    	LaborPrice(City1)=1024:Labor(City1)=50     '=50-RND(5) 'No subtractions yet00053     OldLaborPrice(City1)=LaborPrice(City1)00054    	FOR City2=City1+1 TO NCity:00055       		TransportCost(City1,City2)=RND(10)+2^RND(8)00056       		TransportCost(City2,City1)=TransportCost(City1,City2)+RND(10)-500057    	NEXT City200058    	TransportCost(City1,City1)=000059 NEXT City100060 '00061 FOR City=1 TO NCity:00062       FOR Good=1 TO NGood:00063         	ProdnCost(Good,City)=RND(6)-100064       NEXT Good:00065       OneCityFactor!(City)=.05  '*** Play with this value ***00066 NEXT City00067 '00068 OldTotalExcessDemand!=100000000069 '00070 FirstCityFlag=True00071 '00072 RETURN00073 00074 "Calculate Demands":  'Calculates demand for labor in each city, given labor prices00075    	NetWealth=0:GrossWealth=000076    	FOR City=1 TO NCity STEP 1  'Calculate effect on league wealth of trade missions00077       		LaborWorth(City)=LaborPrice(City)*Labor(City)00078         NetWealth=NetWealth+LaborWorth(City)00079       		GrossWealth=GrossWealth+LaborPrice(City)*5000080       		LaborDemand(City)=0  'Set demand for city's labor 0 to start00081    	NEXT City00082 	   WealthFraction!=NetWealth/GrossWealth00083    	NetLabor!=50*WealthFraction!00084    	FOR City=1 TO NCity STEP 1:00085       		LaborDemand(City)=0  'Set demand for city's labor 0 to start00086     NEXT City00087 '00088    	FOR BuyingCity=1 TO NCity STEP 1:00089       		FOR Good=1 TO NGood:00090          			Cost&(Good)=CostMax00091          			FOR SellingCity=1 TO NCity:00092 	             LONG IF 	ProdnCost(Good,SellingCity)<>0      'Nonzero=True00093 	               				Cost&=ProdnCost(Good,SellingCity)+TransportCost(SellingCity,BuyingCity)00094 	               				Cost&=Cost&*LaborPrice(SellingCity)00095 	               				IF Cost&<Cost&(Good) THEN Cost&(Good)=Cost&:BestSeller(Good)=SellingCity00096 		           	END IF00097 				        NEXT SellingCity00098       		NEXT Good00099       		Wealth=LaborPrice(BuyingCity)*50  'NetLabor!   'Wealth of Buying City (after taxes)00100       		FN MaxUtility(Wealth,Cost&(1),Cost&(2),Cost&(3),Cost&(4),Cost&(5))00101         FOR Good=1 TO NGood:00102       		   	LaborDemand(BestSeller(Good))=LaborDemand(BestSeller(Good))+Quantity!(Good)*Cost&(Good)00103         'This is demand for BestSeller's labor measured in dollars not hours00104       		NEXT Good00105    	NEXT BuyingCity00106 RETURN00107 '00108 '00109 "Calculate Excess Demands":  'Calculates Demand minus Labor available (in dollars, not hours)00110 OldTotalExcessDemand!=TotalExcessDemand!00111    	TotalExcessDemand!=000112     NetExcessDemand =000113   	FOR City=1 TO NCity:00114       	CityExcessDemand(City)=LaborDemand(City)-LaborWorth(City)00115        NetExcessDemand =NetExcessDemand+(CityExcessDemand(City))00116      		TotalExcessDemand!=TotalExcessDemand!+ABS(CityExcessDemand(City))00117   	NEXT City00118 RETURN00119 '00120 '00121 "Change Many Cities"   00122    Improvement=(OldTotalExcessDemand!-TotalExcessDemand!)00123    LONG IF Improvement<0   'If things are getting worse, back up, reduce adjustment factor00124      PriceAdjustment!=PriceAdjustment!*.200125      OneCityFactor!=.00500126       FOR City=1 TO NCity00127          LaborPrice(City)=OldLaborPrice(City)00128       NEXT City00129    XELSE00130      IF Improvement<.1*OldTotalExcessDemand! THEN PriceAdjustment!=PriceAdjustment!*200131       FOR City=1 TO NCity00132          OldLaborPrice(City)=LaborPrice(City)00133          LaborPrice(City)=LaborPrice(City)+CityExcessDemand(City)*PriceAdjustment!00134       NEXT City00135    END IF00136 RETURN00137 00138 "Change One City":00000    BestRelativeExcessDemand!=000000   	FOR City=1 TO NCity:00141       RelativeExcessDemand!=ABS(CityExcessDemand(City)\LaborWorth(City))00000       LONG IF RelativeExcessDemand!>BestRelativeExcessDemand! 00143          CityToChange=City:BestRelativeExcessDemand!=RelativeExcessDemand!00000       END IF00145    NEXT City00146 CityToChange=1+Iteration MOD NCity00147    Improvement=(OldTotalExcessDemand!-TotalExcessDemand!)00148    LONG IF Improvement<0   'If things are getting worse, back up, reduce adjustment factor00149       LaborPrice(OldCityToChange)=OldLaborPrice(OldCityToChange)00150       OneCityFactor!=OneCityFactor!*.2500151    XELSE00152      ' IF Improvement<.05*OldTotalExcessDemand! THEN OneCityFactor!=OneCityFactor!*200153       OldLaborPrice(CityToChange)=LaborPrice(CityToChange)00154       OldCityToChange=CityToChange00155       LaborPrice(CityToChange)=LaborPrice(CityToChange)+CityExcessDemand(CityToChange)*OneCityFactor!00156    END IF00157 RETURN00158 '00159 "Change One City2":00160    IF FirstCityFlag THEN GOSUB "Find City to Change":FirstCityFlag=False00161    Improvement=(OldTotalExcessDemand!-TotalExcessDemand!)00162    SELECT Improvement00163       CASE <0 'If things are getting worse, back up, reduce adjustment factor00000          LaborPrice(OldCityToChange)=OldLaborPrice(OldCityToChange)00000          Tried(OldCityToChange)=True00166          GOSUB "Find City to Change"  'Pick new city to try00167        CASE =0,>000168          ' IF CityExcessDemand(CityToChange)=0 THEN 00000        GOSUB "Find City to Change"00170  '     IF Improvement=0 THEN OneCityFactor!(CityToChange)=1.5*OneCityFactor!(CityToChange)00171    '    CASE >000172           OldLaborPrice(CityToChange)=LaborPrice(CityToChange)00173           OldCityToChange=CityToChange00000           DeltaLaborPrice!=CityExcessDemand(CityToChange)*OneCityFactor!00175           IF INT(DeltaLaborPrice!)=0 THEN DeltaLaborPrice!=SGN(DeltaLaborPrice!)00176           LaborPrice(CityToChange)=LaborPrice(CityToChange)+DeltaLaborPrice!00177        CASE ELSE00178    END SELECT00179 RETURN00180 '00000 "Find City to Change":00000    LONG IF AllCitiesTried00000       FOR City=1 TO NCity:Tried(City)=False:NEXT City00000       AllCitiesTried=True00000       OneCityFactor!=OneCityFactor!*.2500000    END IF00000    BestRelativeExcessDemand!=000000    AllCitiesTried=True00183   	FOR City=1 TO NCity:00000       LONG IF NOT Tried(City)00000          RelativeExcessDemand!=OneCityFactor!(City)*ABS(CityExcessDemand(City))\LaborWorth(City)00185 'PRINT City;RelativeExcessDemand!;CityExcessDemand(City),00000          LONG IF RelativeExcessDemand!>BestRelativeExcessDemand!00000             CityToChange=City:BestRelativeExcessDemand!=RelativeExcessDemand!00000          END IF00000          AllCitiesTried=False00000       END IF00189    NEXT City00190 RETURN00191 